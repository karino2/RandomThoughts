karino2が調べた経済などの統計データをgoogle spread sheetsにまとめているが、それを表示するアプリ。
内部的にはRのサブセットのスクリプトとテキストの解説が降ってきて、それを元にグラフを書いて表示するような作りになっている。

## 更新手順

1. spread sheetのデータを更新
2. チャートをDebug＞Admin＞共有 でgithub pagesのimages下のものを更新
3. scripts.jsonをjson_edit.htmlにロードしてコメントなどを書き換えてscripts.jsonを保存（Command+K、Command+Fでフォーマット）
4. npm run generateでhtmlを生成
5. gitにコミットしてpush

## バックエンドをgithub pagesに変更したい（した）

現状統計グラフ！は、バックエンドにjson engineとgoogle spread sheetを使っている。
前者は単にjsonを吐いたりwebのリンク先urlを作っているだけなので、[GithubPages](GithubPages)に乗り換えたい。
たまに触っては意外とTODOが多くて手がつかずに撤退、を繰り返しているので、少しここに作業メモを書いていく。

やる事

1. jsonをgithub pagesに置いてIf-Modified-Sinceとかがどう出るかを調査
2. OkHttp3でIf-Modified-Sinceの使い方などを調べる
3. jsonを編集するアプリをElectronあたりで作る
4. jsonからhtmlを生成する静的ジェネレータスクリプトを作る
5. アプリの方のリンク先などを変える

3が面倒でやる気を失ったが、そもそも単にhtmlでどうだろう？
結構良い感じになった。これでいいや。

あとは4を作ればやる気になるかなぁ。ただその前に1を調べる方がいいか。

If-Modified-Sinceは普通に動いている。これで良さそう。

あとは4のサイトを生成する所だけやったらアプリ側を変えようか、という気分になった。

[TypeScript](TypeScript)の勉強も兼ねてやって4をやってみたらあっさり出来る。やりたい事が片付けられた、というのは印象良いね。
TypeScriptは別の言語というよりはJSにtype annotation入れてるだけって感じで、ほとんど学ばなくても使い始める事は出来るな。

という事で1, 3, 4が終わった。あとは2と5だけだな。

- OkHttp3でIf-Modified-Sinceの使い方などを調べる
- アプリの方のリンク先などを変える

[Recipes - OkHttp](https://square.github.io/okhttp/recipes/#accessing-headers-kt-java)

### 2023-08-20 (日)

アプリ側を一通り対応して、一つ統計データも更新してみた。
画像共有が動かなくなって対応に苦戦する。

これまではexternal storageにフォルダをほってそこにpngファイルを吐き出し、それをcontent dbに突っ込んだ結果のurlをACTION_SENDのEXTRA_STREAMにくっつけて送っていた。
だがこのexternal storageに書くのができなくなって、DownloadsとかPicturesとかにしか書けなくなった。まぁそれはいい。

で、Downloadsに書いてそれをcontent dbに突っ込んだ結果のurlを同様に渡すと、どうも受け取る側が開けない。
うーん、公式のドキュメントだと以下が該当する所か？ [Sharing files  -  Android Developers](https://developer.android.com/training/secure-file-sharing) 

見てみると何故か途中からインテントを受け取る側のFileProviderの書き方になって、単に送るケースが良くわからない。
仕方ないのでFileProviderのコードを読んでいると、どうもdata下に保存してあるという前提でパスの前半と一致しているかチェックしているな。
つまりDownloads下に置いて共有するケースだとFileProviderは使えないっぽい。

うーん、まぁ画像共有はadmin業務として自分だけが使う機能なので、どうでも良い所ではあるが。

とりあえず`context.getFilesDir()`の下にディレクトリほって共有用のファイルを置く事にする。
ついでにintentに`intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);` もしておいた。
この辺はいろいろ試していたら動いたので、このフラグがいるかは試してないが、まぁいい。

という事で無事共有は動いた。それにしてもAndroid 11はなかなか酷い事になっているな。これだけの変更をしておきながら、標準的なケースで現行機種と将来の機種の両方に対応する推奨方法がどこにも書いていないというのはさすがにダメなんじゃないか。
さすがにもうちょっとしたらまともな対応をするだろうと思ってあまり近づかないでおきたい所。