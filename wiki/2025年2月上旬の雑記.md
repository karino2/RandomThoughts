## 2025-02-01 (土)

なんか1月の電気代が掛かってるな。あれ？でもこれって12月分か？2/1の時点で確定しているんだからそりゃそうか。ややこしいな。

今朝は大雨につき部屋で作業。午後になって雨はあがったが、暴風でしかもこれから干潮なのでどちらにせよ室内待機だなぁ。

[Folang](Folang)のページがだいぶ長くなってきたので整理。謎の独自仕様なども一応書き残しておく。

一時帰宅からの戻り、いつもは戻りのチケットは買わずに行くのだが、
今回はピーチで戻って来るのを試してみようと思い、それなら早割と空港での宿の予約もしたいので先に予約してみる。
9アワーズとかいう空港内カプセルホテルを試してみる事に。6000円ちょい。

夕方散歩がてら海を見に行ったら、サイズは結構上がってたが形がぐじゃぐじゃで厳しい。
たまに乗れるのは来るのだが、来る場所がバラバラでたまにしか来ないので厳しそう。今日はサーフィンはお休みにする。

## 2025-02-02 (日)

朝はまぁまぁ波があるがかなり混んでる。しかもそこまでは波は無い。
昼過ぎを狙うかな〜。

という事で宿で趣味プログラムを進めていたら、うっかり時間が過ぎて潮が引きすぎに。まぁ今日は作業デーにするか。

今日は一日[Folang](Folang)の実装していたら終わってしまった。セルフホストの実装もだんだんとtinyfoの機能追加からセルフホスト側の実装に比重が移ってきた。
セルフホストはもう一度違う言語で実装しなおす事になるので、まぁまぁかったるさがあるな。

## 2025-02-03 (月)

今朝の波チェック、少し残ってはいるが手広は混みすぎ、ビラは本数少ない割に人がちょっといるのでどちらもいまいち。
昼くらいにもう一度見に行っていまいちなら今日は無しかな。

昼はまだかろうじて残っているが人もそれなりには減ってきて、少し迷うが出てみる事にする。入ってしばらくインサイドで乗っていたらさらに人が減ったのでピークで結構乗れる。
ただ1.5時間くらいで潮が引いてきて駄目に。まぁそれなりには乗れた。
今日は結構いいリップが何回か出来たな。

Folangでセルフホストに向けた再実装をするにあたり、雑にやってしまったジェネリクスのあたりをもう少し考え直したい気がしていたので、
少し考えてみた＞[Genericsについてのメモ - なーんだ、ただの水たまりじゃないか](https://karino2.github.io/2025/02/03/generics_memo.html)

だいぶ理解は進んだ気がするな。

お仕事でやってるアプリがアナウンスされた。リリースはもうちょい先だが、終わりが近づいてきた感じするね。

## 2025-02-04 (火)

今日は暴風につき室内で作業。

なんか歯茎が腫れて痛い。ここは神経抜いて薬埋めないとまた腫れるかも、と言われている場所なのでなにか予想外の事が起きているという訳では無いがQoLは下がるな。

寒いのもありやる気が出ないので今日はお休みに。こういう時は無理しない。

## 2025-02-05 (水)

今日は一時帰宅の前なのでちょっと小さめでもサーフィンしようかと思っていたが、まさかのドフラット。これは無理だなぁ。
まぁ昨日仕事もしてないので働いておくか。

午前中はお仕事が割と進んだ。やはりこういう日は仕事を片付けていくのがいいな。

ちょっと仕事の息抜きに[Folang](Folang)を進めたり。

夕方も波が無いのでそのままお仕事。今日は結構進んだ。

夜は[Folang](Folang)のセルフホストの続き。トランスパイラの完成度はだいぶ上がってきたな。

## 2025-02-06 (木)

今朝も波は無いが、明日一時帰宅なので、その前に軽く運動しておくか、と隣のポイントに入る。立つだけという感じだが、多少は運動になった。
気温は上がってきたが風がまだ寒いね。

少し趣味コードを進める。

夕方に旅立ちに向けて少し準備する。ただほとんどは箱に詰めて置いていくか車に入れて置いていくかなのであまりやる事は多くは無いな。

手荷物の重さをチェック。カバンにPCとタブレット２つで3.7kg。7kgなので他に細々としたものを足しても余裕だな。
やはりピーチはキャリーバッグじゃなければ良いという事か。
PCのアダプターとシェーバー足しても良さそうかな。

## 2025-02-07 (金)

予定より1.5時間ほど早く目が覚めてしまったが、車への積み込みとかやる事はあるので行動開始。

9:50 搭乗口前で時間待ち。10:35出発。作業ブースが埋まっているので席で作業。

機内のテーブルで作業しようとしたら狭すぎてPCを開けない！
まぁいいか、と膝において作業。

シンタックスのノイズ

また飛行機内の暇つぶしエッセイ。

昔ベックマンがチャンネル9でHaskellやF#では、シンタックスを数学に近づけたい、なぜならそっちの方が数学的に考える時にノイズが少ないからだ、
みたいな事を言っていた気がする。
その事を思い出した、という話。

最近[Folang](Folang)でgoで書いたトランスパイラをセルフホストのために再実装している。
同じような実装をgoとfolangで書く事になるので、両者の特徴というか出来上がるコードの違いがなかなか興味深い。
基本的にはfolangの実装はF#で実装した場合とほとんど同じ感じとは思うので、以下はF#とgolangの話と思って読んでもらっておおむね良い。

セルフホストのためには再実装が必要なのだが、同じものを二回、しかも比較的最近実装したものをもう一回実装するのはかったるい。
だからとっとと終わらせたいし、デバッグとかもしたくないので、なるべくなら同じ実装にしたい。

けれどfolangにはいくつかの機能が無いのでそのままでは書けないし、書けたとしてもfolang的で無い書き方がちょくちょくあり、
そういうのはfolang的になるように変更している。
例えばトークナイザはstructのposを更新するのでは無く、新しいトークナイザを返すようにする、とか、
Discriminated Unionでよりちゃんと型のモデリングをするとか。

その中の結構大きな変更の一つに、相互再帰がうまく書けないので関数オブジェクトを渡すように変更する、というのがある。
相互再帰、F#ではandを使って書けるのだけれど、あまり推奨はされていない。
Folangでは関数定義のandはサポートしていない（型定義はしている。Discriminated Unionとレコードの相互参照は必須だろうから）。
という事でF#的な推奨方法に直す事になるのだが、それが関数オブジェクトを渡す、という事。

例えばExprのトランスパイルの関数をExprTransと呼ぶ事にする（コード上ではExprToGoと呼んでいるがこの名前はいまいちだったと思っている）。
そしてStmtのトランスパイルをStmtTransと呼ぶ事にする。

Folangは全部Exprという訳では無い上に、BlockというExprがStmtを持てるので、
ExprTransはStmtTransを必要とし、StmtTransはExprTransを必要とする。
こういうの、golangではそのまま書ける。

```
func ExprTrans(expr Expr) string {
   ...
   StmtTrans(stmt)
   ...
}

func StmtTrans(stmt Stmt) string {
   ...
   ExprTrans
   ...
}
```

golangなどの多くの言語は関数定義は使うよりあとでも平気になっている。
C言語などの言語でも、宣言を先に持ってくる、という方法で、少し原始的だが同じ事が出来る。

だが、F#ではこの手の仕組みが無い。
関数の呼び出しは定義よりあとじゃないといけないので、こういう事を上手く書けない。

そこでどうするか、というと、関数オブジェクトを渡す感じにするのが定石となる。
F#知らんがな、という人のためにgoで書くと以下のような感じ。

```
func ExprTrans(stmtTrans func(Stmt) string, expr Expr) string {
   ...
   stmtTrans(stmt)
   ...
}
```

このようにstmtTransという関数オブジェクトを引数に追加してそれを使う。
そしてStmtTransの方ではこれを渡すようにすると、自己の再帰だけで済む。

```
func StmtTrans(stmt Stmt) string {
   ...
   ExprTrans(StmtTrans, expr) // <- StmtTrans自身を渡す
   ...
}
```

わざわざ高階関数にするのは読みにくいし良い事無い気がする。実際golangではそうだ。
でもF#はそういうものだ。これは非常に良く出てくるので、関数オブジェクトだらけになって、それが実際にどれなのかは非常に分かりにくい。
F#系の言語が慣れないと読みにくいのもこれが原因の一つだろう。

関数オブジェクトがめちゃくちゃたくさん出てくるので、このシンタックスのノイズが小さい、というのはかなり重要だ。
両者の定義を並べてみる。

- `stmtTrans func(Stmt) string`
- `stmtTrans: Stmt->string`

stmtTransの方が、認知的な負荷が（自分には）低い。
この差はちょっとした違いなのだけれど、たくさん増えてくるとこのちょっとの違いが大きくなる。

この認知的な負荷が低いおかげで、この手の作業を続けていくと、考え方に反転が起こる。
ExprTransを書く時に、StmtTransを関数オブジェクトとして渡すのでは無く、
Stmtからstringへの変換をするなにかを使ってExprTransを書く、
という風に、現在実装中の関数に必要なものを単に引数に並べる、というような感覚で書くようになるのだ。
ExprTransを実装する時に他の事は考えない。単にそういう道具がある、と考えるようになる。
こうなると関数オブジェクトばかりで実際にはなんの関数が渡されるのか、とかはあまり気にしなくなって、
コードが読みやすくなる。
この時にシンタックスにノイズが無いというのが結構重要で、ノイズがあるとそう考えるのがちょっと大変なのだ。
うまく説明は出来ないが、関数型言語が好きな人は皆この感覚には同意してくれるんじゃないか。

これは他の言語のトップダウンでのコードの書き方に似ている。
必要なinterfaceなどをまず作って、それを使ったコードを書く。
次にそのinterfaceを実装する側を書く、という。
これが出来るのが初級と中級のプログラマを分ける一つだと個人的には思っているが、
中級のプログラマならまぁ誰でも出来るし日々やっている事でもあるだろう。