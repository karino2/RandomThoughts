## 2023-10-21 (土)

波は残らなかったようなので今朝は暇になる。
[[Kotlinリファレンスの和訳]]を進めるなど。

audiobookを聞いたりしつつ、リファレンスの和訳をしたりする。

## 2023-10-22 (日)

朝は[[【書籍】サピエンス全史]]を聞くなど。下巻に入って聞くに堪えない感じでは無くなってきた。

malloc置き換えとして[microsoft/mimalloc: mimalloc is a compact general purpose allocator with excellent performance.](https://github.com/microsoft/mimalloc)を評価していたら、なかなか早くなっている。
ただそのままではこちらの事情で組み込めないケースがあるので、
これが何をやっているか理解したいな。

論文はこれか＞[Mimalloc: Free List Sharding in Action - Microsoft Research](https://www.microsoft.com/en-us/research/publication/mimalloc-free-list-sharding-in-action/)

先週のサーフィンを録画してもらったものを見ているが、結構上手くなってるな、自分。
テイクオフの時に経った時点で腰が高いというか、立ち上がる時にもう腰が高くて上半身が後から立つ感じになっているので、
これを直すのが良さそう。
ちょっと陸トレしてみよう。

mimallocの論文を途中まで読んで、その後コードを少し眺めてみる。thread locla storageにheapオブジェクトみたいなのを置いているが、
これはスレッドが無くなった時にどうなるんだろう？

_mi_thread_doneか。ちょっとこの辺はコード読みページ作るかな？

理解は深まったが、やはり一般的ゆえの面倒さがいろいろあるなぁ。

follyのThreadCachedArenaはなかなか良くできてて、そうそう、こういう感じだよ、ってものなんだがなぁ。
こういうのがサーバーサイド以外でも使えればいいんだけれど。

## 2023-10-23

品川で友人とダベる。採用は雇うなら雇う、雇わないなら雇わないでバシっと言ってあげてよ、みたいな話をするなど。

少し新宿の本屋によってkotlinとかAndroidの本を軽く見たり、最近の関心の並列アロケータについて見るがめぼしいものはなし。
Androidはこれじゃあ駄目だよな、という内容が多く参考にならない。
Kotlinの本は薄くて簡素なので、もうちょっと初心者向けに詳しい方がいいのになぁ、とは思うが、それなりに初学者向けに書かれているものはある。薄い本で頑張ってやるのもできなくは無さそう。

並列アロケータみたいな話は全然無い。
最近はC++の現場と書籍の間の乖離が随分大きくなった気がするがどうだろう？
follyには多くの知見が詰まってるが、それが本棚には無い。

follyのThreadLocalはC++のthread_localと何が違うんだ？と思っていたら、youtubeで解説を見つけた。 [CppCon 2016: David Watson “Experiences with Facebook's C++ library" - YouTube](https://www.youtube.com/watch?v=GDxb21kEthM)

なるほど、メンバ変数で使いたい場合に使えるのか。逆にメンバじゃなくて良ければthread_localでいいんだな。

## 2023-10-24 (火)

今日はmimallocのうち、お仕事で関係ありそうな所だけをちゃんと読む。せっかくなのでコード読みブログでも書くかな。

今日は早起きして午前中に十分働いてしまってこれ以上進む気もしなかったので、午後は散歩したりカフェで読書したり。
[[【書籍】ConcurrentProgrammingOnWindows]]を読んでいる。
でもこれよりももっと教科書っぽいの読む方がいいかもしれん。

帰ってきてabema見たら河村カイサのRound 3がやってたので見てみた。おー、なんかうまく試合運んだね。
Round 2も見たかったな。

## 2023-10-25 (水)

mimallocのうち必要な所だけを軽く読もうとしているが、思ったより大変なのでブログを書く事にする。
とりあえずmalloc_genericのうちスライスから取り出すあたりまでを読む。
もう少し読んでから1ポストにしようと思っていたが、かなり長くなってきたので切る事に。

[mimallocコード読み、malloc_generic前篇](https://karino2.github.io/2023/10/24/mimalloc_code_reading.html)

[[【書籍】ConcurrentProgrammingOnWindows]]を読んでいて、Reader Writer LockのWindowsAPIを見て、
そういえばSTLでreader-writer lockってどうなっているんだろう？と調べると、C++ 14からshared_timed_mutexとshared_lockというのが入ったらしい。
C++ 17にはshared_mutexというのがあってこっちの方が軽いらしい。うげぇ。

[c++ - Why shared_timed_mutex is defined in c++14, but shared_mutex in c++17? - Stack Overflow](https://stackoverflow.com/questions/40207171/why-shared-timed-mutex-is-defined-in-c14-but-shared-mutex-in-c17)

これは残念な歴史的偶然。timeoutなんて無い版を先に入れておけばなぁ。

なんにせよshared_timed_mutexは自分で実装するよりは良かろう。

## 2023-10-26 (木)

mimallocのコード読みをしていたが、思ったより大変。ただ割と全体の構造は把握出来てきたので、だいたい予想出来るようにはなってきた。
知りたいところの核心を読んで終わりにしたいかな。

## 2023-10-28 (土)

昨日は雑記を書いていなかったか。あおぞら教室してmimallocのコードを読んでいた。

今日も午前中はmimallocのコードを読んでいた。だいぶ理解は深まってきた気はする。