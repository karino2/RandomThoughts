import{_ as a,c as i,a as o,o as r}from"./app-CHiHTJW6.js";const t={};function m(d,e){return r(),i("div",null,[...e[0]||(e[0]=[o('<p>[[Mac]]より。iOS関連で動画のエンコードや配信周りがどうなっているかを調べる。WikiNameとしてはOS関係なく動画配信全般にしておく。</p><p>[[YouTubeAPI]]や[[Twitch]]で配信するようなケースで、iOS側はどうなっているかを調べるメモ。</p><p><a href="https://developer.apple.com/documentation/http-live-streaming" target="_blank" rel="noopener noreferrer">HTTP Live Streaming - Apple Developer Documentation</a> あたりから見るのか？</p><h2 id="fragmented-mpeg-4とavassetwriter" tabindex="-1"><a class="header-anchor" href="#fragmented-mpeg-4とavassetwriter"><span>Fragmented MPEG-4とAVAssetWriter</span></a></h2><p><a href="https://developer.apple.com/videos/play/wwdc2020/10011" target="_blank" rel="noopener noreferrer">Author fragmented MPEG-4 content with AVAssetWriter - WWDC20 - Videos - Apple Developer</a></p><p>この一つ手前のエンコーダーのあたりを知りたいのだが、とりあえずの取っ掛かりとして。 このサンプルコードからたどって見つけた。 <a href="https://developer.apple.com/documentation/avfoundation/media_reading_and_writing/writing_fragmented_mpeg-4_files_for_http_live_streaming?language=objc" target="_blank" rel="noopener noreferrer">Writing Fragmented MPEG-4 Files for HTTP Live Streaming - Apple Developer Documentation</a></p><p>この動画はやりたい事とは違いそうだが、情報量が多いのでなかなか良い。</p><p>Working with Media in AV Foundation (WWDC11)がみたい動画っぽいが見つからないな。</p><p>ただAV Foundation周りを調べると良さそうか。</p><h2 id="av-foundation" tabindex="-1"><a class="header-anchor" href="#av-foundation"><span>AV Foundation</span></a></h2><p><a href="https://developer.apple.com/av-foundation/" target="_blank" rel="noopener noreferrer">AVFoundation Overview - Apple Developer</a></p><p><a href="https://www.youtube.com/watch?v=mCiZW2xW4Ks" target="_blank" rel="noopener noreferrer">Apple iOS Development: Understanding AV Foundation - YouTube</a></p><p>Playbackの解説と、Editingの解説が詳しい。Editingは役に立ちそう。AVComposition、AVAudioMixなどの解説や時間などがどう表されるかなどの解説。</p><p>最後に言及されてたサンプルコード</p><ul><li>RosyWriter</li><li>AVReaderWriter for OSX</li></ul><h2 id="audioのキャプチャ" tabindex="-1"><a class="header-anchor" href="#audioのキャプチャ"><span>Audioのキャプチャ</span></a></h2><p>オーディオというよりはステレオの話だが、サンプルコードは参考になりそう。</p><p><a href="https://developer.apple.com/documentation/avfaudio/capturing_stereo_audio_from_built-in_microphones?language=objc" target="_blank" rel="noopener noreferrer">Capturing stereo audio from built-in microphones - Apple Developer Documentation</a></p><p>WWDCのこの動画が同じ内容か？ <a href="https://developer.apple.com/videos/play/wwdc2020/10226/" target="_blank" rel="noopener noreferrer">Record stereo audio with AVAudioSession - WWDC20 - Videos - Apple Developer</a></p><p>なんかAVAudioRecoderはファイルに書く奴っぽいので、サンプルバッファが取れるのは無いのか？ とググっていたらその辺の比較をしているブログを見つけた。 <a href="https://dolby.io/blog/recording-audio-on-ios-with-examples/" target="_blank" rel="noopener noreferrer">Recording Audio on iOS with Examples - Dolby.io</a></p><h2 id="エンコードとデコードのsample-bufferの直接アクセス" tabindex="-1"><a class="header-anchor" href="#エンコードとデコードのsample-bufferの直接アクセス"><span>エンコードとデコードのsample bufferの直接アクセス</span></a></h2><p>AVAssetWriterのdelegateの返すsegmentedDataがなんなのか全然分からなくて調べていた所見つけた動画。とても良いのでサブセクションを作る。 AV Foundationでは無くその下のVideo Toolboxを使うらしい。</p><p><a href="https://developer.apple.com/videos/play/wwdc2014/513/" target="_blank" rel="noopener noreferrer">Direct Access to Video Encoding and Decoding - WWDC14 - Videos - Apple Developer</a></p><p>参照されてる動画で気になったの</p><ul><li>WWDC 2013 Moving to AVKit and AVFoundation</li></ul><h3 id="扱う4つのユースケース" tabindex="-1"><a class="header-anchor" href="#扱う4つのユースケース"><span>扱う4つのユースケース</span></a></h3><p>ユースケースとして以下を挙げている</p><ol><li>Displaying an H.264 stream in a layer in your application</li><li>Decoding an H.264 stream and accessing the decoded buffers</li><li>Compressing a sequence of images into a movie file (27:50あたりから）</li><li>Compressing a sequence of images into an H.264 stream for the network</li></ol><h3 id="良く出てくる登場人物" tabindex="-1"><a class="header-anchor" href="#良く出てくる登場人物"><span>良く出てくる登場人物</span></a></h3><p>6分あたり。</p><ul><li>CVPixelBuffer ... 非圧縮の画像バッファ</li><li>CVPixelBufferPool ... CVPixelBufferのバッファプール</li><li>pixelBufferAttributes ... 幅、高さ、32RGBAなど</li><li>CMTime</li><li>CMVideoFormatDescription ... width/height, フォーマットタイプとしてkCMPixelFormat_32RGBA、kCMVideoCodecType_H264など</li><li>CMBlockBuffer ... 圧縮されたビデオフレームのデータなど</li><li>CMSampleBuffer ... 圧縮されたビデオフレームと非圧縮のビデオフレームの二種類がある。以下を含む。 <ul><li>CMTime ... プレゼンテーションタイム</li><li>CMVideoFormatDescription</li><li>圧縮されたビデオの場合 ... CMBlockBuffer</li><li>非圧縮されたフレームの場合 ... CVPixelBuffer</li></ul></li><li>CMClock ... mach_absolute_timeなどの勝手に進むなにかのラッパ</li><li>CMTimebase ... CMClockを元に原点を決めたりとかいろいろ操作した時間</li></ul><p>この辺は良く出てくるのでありがたい。</p><h3 id="h-264のストリームのデコード-1つ目のケース" tabindex="-1"><a class="header-anchor" href="#h-264のストリームのデコード-1つ目のケース"><span>H.264のストリームのデコード（１つ目のケース）</span></a></h3><p>10:00あたりから。15:00あたりからネットワークからCMSampleBufferへのコンバートの話が出てくる。</p><p>NetworkからくるH.264ストリームはElementary Streamと呼ばれる形式で、それとファイルに保存されるMPEG-4をベースとしたCMSampleBufferの間には変換が必要となる。</p><p>NAL Unitからmp4のCMVideoFormatDescriptionを作るのはCMVideoFormatDescriptorCreateFromH264ParameterSets。</p><p>CMSampleBufferを作るのに必要なのは以下の３つ。</p><ul><li>CMTime</li><li>CMVideoFormatDescription</li><li>NAL Unit （ヘッダを長さに置き換える必要あり）</li></ul><p>この３つを、CMSampleBufferCreateに食わせる。</p><h3 id="vtdecompresssessionによるデコードした画像へのアクセス" tabindex="-1"><a class="header-anchor" href="#vtdecompresssessionによるデコードした画像へのアクセス"><span>VTDecompressSessionによるデコードした画像へのアクセス</span></a></h3><p>20:00あたりから、ネットワークのストリームをデコードしてCVPixelBufferにアクセスする例に入る。 これにはVTDecompressSessionを使う。 この中にVideoDecoderが入っているらしい。</p><h3 id="vtcompressionsessionでネットワークに圧縮フレームを直接送る" tabindex="-1"><a class="header-anchor" href="#vtcompressionsessionでネットワークに圧縮フレームを直接送る"><span>VTCompressionSessionでネットワークに圧縮フレームを直接送る</span></a></h3><p>29:00あたりからCVPixelBufferを圧縮してネットワークに送る例が始まる。</p><p>VTCompressionSessionEncodeFrameでpixelBufferを送るっぽい。</p><p>最後に待つのはVTCompressionSessionCompleteFramesらしい。</p><h3 id="elementary-streamへの変換" tabindex="-1"><a class="header-anchor" href="#elementary-streamへの変換"><span>Elementary Streamへの変換</span></a></h3><p>34:00あたりからElementary Streamへの変換の話がある。 SPSとPPSを最初に送る必要があるが、これはCMVideoFormatDescriptionGetH264ParameterSetAtIndexというそのものずばりの関数がある。</p><p>次にNAL Unitの変換。I Frameなどは先頭に4バイトのlengthが入っているので、これを00 00 01の3 byteの開始コードに変換する必要がある。</p><h2 id="メモ" tabindex="-1"><a class="header-anchor" href="#メモ"><span>メモ</span></a></h2><p>使うか分からないメモを置いておく</p><ul><li><a href="https://iphome.hhi.de/suehring/tml/download/" target="_blank" rel="noopener noreferrer">Karsten Suehring</a> H.264のリファレンスインプリメンテーションか？ <a href="https://stackoverflow.com/questions/27090114/what-does-elementary-stream-mean-in-terms-of-h264" target="_blank" rel="noopener noreferrer">ffmpeg - What does Elementary Stream mean in Terms of H264 - Stack Overflow</a>より。</li></ul>',51)])])}const n=a(t,[["render",m]]),l=JSON.parse('{"path":"/%E5%8B%95%E7%94%BB%E9%85%8D%E4%BF%A1.html","title":"","lang":"en-US","frontmatter":{},"git":{"updatedTime":1722996342000,"contributors":[{"name":"Kazuma Arino","username":"","email":"hogeika2@gmail.com","commits":30}],"changelog":[{"hash":"4acfc39d8a666e96ef9e8f12cb36f6cfd2cba2a4","time":1722996342000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"495ddd2d75b390529fc95b787364b5cd8ca53c89","time":1718705139000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"a05f1f543e35666c5b784539270d5752bcc421a3","time":1718168739000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"8e60686972a9b07fd3c652f5a181efa11d789181","time":1718075143000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"ce071e276fdd64ad25b2c6feda8676d35447d19f","time":1717812336000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"8f23842026f5f42fbfc12875c386f1d6fec9ddbe","time":1717478846000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"3c6d341f795d5590fda367d73b5e56d50cd273fa","time":1717473935000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"2107c9e9d4457109d45c50f9415f89f005fded45","time":1717471611000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"97181c57263b9aa9b8f2a13445578e01ac8c797d","time":1716343536000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"d9c95dc0745e1d07e042c5c426c64b435864e62c","time":1716181539000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"7eb048f02c2d048dcaa80e0bf61937d11104815e","time":1716177978000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"9de8093bf5d9832dec58a852daea7a6d301c692c","time":1716012335000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"6d5437418427dd733d2d870d5b3ff6c4f855ecad","time":1710482750000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"979cd09a5230bd603d65671d87d23c2d0eda7c0d","time":1708563935000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"83d099f3dfe27912ec894ade068cec8adcc5de64","time":1695621937000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"b228aa979367a2668601977da6a5dcf2ecb02a5c","time":1693582839000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"59d110a23fe45d895689230a13d727d20779b473","time":1689211017000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"4aaf2dd35279427f584450d8ab11f5dd2b1a31dd","time":1682910327000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"41d6e99a66d223d738c1e691c681d5e162e71fa8","time":1681707929000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"5bfa964cc2da7b8aed27dcd1f0400bb876419d48","time":1664452079000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"c37f647079849a9c5bb2f9e3b9076c2f1eb514f4","time":1661517297000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"30d42aa1e20014407da6d265adff9b481df5a262","time":1656044763000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"731cf51bbf38552c650f5eb0edd06efe4d65c3d7","time":1653536247000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"5e4c3fe683aecb7ea3da2c30dd975b5721b2ccec","time":1652950086000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"0261d31b9bdb74d73e1cb62621eebd495083d805","time":1652254091000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"f15f29eabbf52ebd6140d4ef919870e4b8adbb1d","time":1650332394000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"51017249548fd4e283d16d9ca0128fdffff08bc9","time":1646308727000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"d88b6b8e0652dfa6733aa36d6f0f44584124d831","time":1645761930000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"8e9ef4d4eb5867c0dd7bfb113c970cacd19699a0","time":1644923667000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"},{"hash":"4fcf0205f6ac9866af46f402aadb2c00edb47047","time":1642043880000,"email":"hogeika2@gmail.com","author":"Kazuma Arino","message":"update"}]},"filePathRelative":"動画配信.md"}');export{n as comp,l as data};
