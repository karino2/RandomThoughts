とりあえずプログラム関連のメモを書くので[[技術的なメモ]]から。

## 雑多なリンク

- [Fuego](https://fuego.sourceforge.net/)
- [GNU Go - GNU Project - Free Software Foundation (FSF)](https://www.gnu.org/software/gnugo/)
- [ligi/gobandroid: A Goban for Android](https://github.com/ligi/gobandroid) 昔のAndroid用。結構大掛かりでGnuGoとかをプラグインとして組み込めそう
   - [icehong/gobandroid: A Goban for Android](https://github.com/icehong/gobandroid/tree/master) 一応まぁまぁ最近のASでビルドしたっぽいfork、PR用に作られていて放置されている
- [lightvector/KataGo: GTP engine and self-play learning in Go](https://github.com/lightvector/KataGo?tab=readme-ov-file)
- [BadukAI](https://aki65.github.io/) Android用のアプリでkatagoやleelazeroが動くらしい。これでいいのかもしれない。でもソースは無さそう。
- [featurecat/lizzie: Lizzie - Leela Zero Interface](https://github.com/featurecat/lizzie/tree/master) Javaで書かれたleela zeroのGUIクライアント。これの移植をベースにしたいかもしれない。
- [pasky/michi: Minimalistic Go MCTS Engine](https://github.com/pasky/michi/tree/master) めちゃ小さいpython実装のMCTSエンジン。移植も出来そう。
- [Sabaki/docs/guides/engines.md at master · SabakiHQ/Sabaki](https://github.com/SabakiHQ/Sabaki/blob/master/docs/guides/engines.md) Sabaikiのエンジンの所にいろんなエンジンへのリンクがある。
- [sanderland/katrain: Improve your Baduk skills by training with KataGo!](https://github.com/sanderland/katrain) 弱いモードがある？あとで調べる

## GnuGo 2.6

GnuGoの3系列は強すぎる。2系列は少し弱いらしいのだが、かなり古いのでビルドなどに多少手直しがいる（GTPサポートも無い）

ということで多少手直しして触ってみる。

[GNU Go - GNU Project - Free Software Foundation (FSF)](https://www.gnu.org/software/gnugo/devel.html)

追記: 以下はバグってた。-D 0でもamigoより強いし、-D 2と自分が同じくらい。（修行lv 3と同じか少し強いくらい）

2.6のコードをちょっといじってビルドを通し、ちょっといじってgtp対応してみる。
amigoよりも強いが、`-D 3`だとamigoに負ける。

そしてgnugo 2.6のD 4だと自分とだいたい五分くらいだ。たまに待ったすれば勝てるくらい。修行の3はこっちの方が近いかも。

いい感じになったので公開。

[karino2/GnuGo2Fork: Fork for gnugo 2.6.](https://github.com/karino2/GnuGo2Fork)

翌日試したらDを一つ間違っている気がする。D 2だとamigoといい勝負、D 3だと勝つ。D 3だと自分は勝てない。

さらに調べていて、どうも二回目以降はいろいろ前の状態を引き継いでバグっていた。
修正したらgnugo3とfinal_scoreが一致するようになった。

直したらD1でもamigoに負けなくなった…うーん、ちょっと強すぎるな。

## AmigoGtp

手頃な弱さの囲碁エンジンを探していて、AmigoGtpというものを知る。
ビルドして触ってみるとGnuGo 2.6より一回りくらい弱い感じで、初心者でも勝てるがランダムという感じでもなく割といい相手。

オリジナルはSourceforgeだが、GithubでMacのビルドをして公開しておく。そのうちNDK対応したい。

[karino2/AmigoGtpFork: Fork of AmigoGtp.](https://github.com/karino2/AmigoGtpFork)


## 自分用のAnddroid版の囲碁アプリを作りたい

囲碁であそぼ、の修行編のlv3くらいでいいんだが、あれに検討をつけたい。
広告とか無くしょぼいのが動くくらいでいいので。

方針としては碁盤の基本的なアプリを作って、細かい所は既存のモデルを使えないかなぁ、と思っている。とりあえず雑多なメモはここに書いていく。

ある程度まとまったら別のところに移動していく。

### gobandroidいじり

- guavaとかをdependenciesに追加
- ライブラリを適当にアップデート
- AndoidManifests.xmlにGnuGoのサービスのqueryを追加

このくらいで動いた。検討出来ないのかな？

### katagoのNDKでのビルド

NDKでビルドしてみる。大変かしら？

まずは公式をgit clone。

```
$ git clone https://github.com/lightvector/KataGo.git
```

そしてndkのビルドをする。

```
$ export ANDROID_NDK_HOME=~/Library/Android/sdk/ndk/25.2.9519653
$ cd cpp
$ mkdir build
$ cmake . -B build -DCMAKE_TOOLCHAIN_FILE=${ANDROID_NDK_HOME}/build/cmake/android.toolchain.cmake -DCMAKE_BUILD_TYPE=Release -DANDROID_NATIVE_API_LEVEL=33 -DANDROID_NDK=${ANDROID_NDK_HOME} -DANDROID_ABI=armeabi-v7a -DUSE_BACKEND=EIGEN
```

Eigenが見つからんと言われた。
Eigenはヘッダだけinclude出来る場所に置けば良さそうだな。

ダウンロードはここか？

[Eigen](http://eigen.tuxfamily.org/index.php?title=Main_Page#Download)

なんかhttpsじゃないんだが…

とりあえず3.4.0をダウンロードする。
そしてcpp/external下に置く。

```
cpp $ cd external
cpp/external $ tar xzvf eigen-3.4.0.tar.gz
# cpp/external/eigen-3.4.0が出来る
```

次にこれをCMakeLists.txtに加えればいいのか？

```
include_directories(external/eigen-3.4.0)
```

そしてfind_packageで怒られるのでコメントアウトしておく。

```
#    find_package(Eigen3 REQUIRED)
#    include_directories(SYSTEM ${EIGEN3_INCLUDE_DIRS})
 #   message(STATUS "Found Eigen3 at ${EIGEN3_INCLUDE_DIRS}")
 message(STATUS "Skip eigen3 package find")
```

なんかlibzipがないからself playはzipの結果書き出しが出来ないから出来ないよ、とか言われるがしないのでいいだろう。

ではビルド。

```
$ cd build
$ make -j 16
```

なんか以下のエラーが出た。

```
KataGo/cpp/core/sha2.cpp:205:2: error: Define BYTE_ORDER to be equal to either LITTLE_ENDIAN or BIG_ENDIAN
#error Define BYTE_ORDER to be equal to either LITTLE_ENDIAN or BIG_ENDIAN
```

まぁどうせlittle endianでいいんだが、CMakeだけにしておきたいな。という事でさっきのmessageの下に以下を追加。

```
    message(STATUS "Skip eigen3 package find")
    # NDK
    target_compile_definitions(katago PRIVATE BYTE_ORDER=1234)
    target_compile_definitions(katago PRIVATE LITTLE_ENDIAN=1234)
    target_compile_definitions(katago PRIVATE BIG_ENDIAN=4321)
```

これでビルド出来た。
ビルドした結果はexeになってしまっている気がするな。

```
build $ file katago
katago: ELF 32-bit LSB pie executable, ARM, EABI5 version 1 (SYSV), dynamically linked, interpreter /system/bin/linker, BuildID[sha1]=a209a1e7210ea98f1bebe78b6122bb0621b09b5d, with debug_info, not stripped
```

adb shellで動かしてみるか？

```
build $ export PATH=$PATH:~/Library/Android/sdk/platform-tools
build $ adb push katago /sdcard/temp/katago
build $ adb shell
penang:/ $ cd /sdcard/temp
penang:/sdcard/temp $ ./katago
/system/bin/sh: ./katago: can't execute: Permission denied
126|penang:/sdcard/temp $ chmod +x katago
penang:/sdcard/temp $ ./katago
/system/bin/sh: ./katago: can't execute: Permission denied
```

なんで？
sdcard下は実行出来ないんだった。

```
$ adb shell
/ % cd /data/local/tmp
/data/local/tmp % cp /sdcard/temp/katago ./
/data/local/tmp % chmod 755 katago
/data/local/tmp % ./katago
penang:/data/local/tmp $ ./katago

Usage: ./katago SUBCOMMAND

---Common subcommands------------------

gtp : Runs GTP engine that can be plugged into any standard Go GUI for play/analysis.
benchmark : Test speed with different numbers of search threads.
genconfig : User-friendly interface to generate a config with rules and automatic performance tuning.
# 以下略
```

おぉ、動いた！

モデルとcfgを動かしてgtpモードで動かしてみよう。

```
Mac$ adb push g170e-b20c256x2-s5303129600-d1228401921.bin.gz /sdcard/temp/
g170e-b20c256x2-s5303129600-d1228401921.bin.gz: 1 file pushed, 0 skipped. 37.4 MB/s (87358203 bytes in 2.229s)
Mac$ adb push ./cpp/configs/gtp_example.cfg /sdcard/temp/
./cpp/configs/gtp_example.cfg: 1 file pushed, 0 skipped. 67.7 MB/s (32457 bytes in 0.000s)
Mac$ adb shell
penang:/ $ cd /data/local/tmp
penang:/data/local/tmp $ cp /sdcard/temp/g17* ./
penang:/data/local/tmp $ cp /sdcard/temp/gtp* ./
penang:/data/local/tmp $ ./katago gtp -model g170e-b20c256x2-s5303129600-d1228401921.bin.gz -config gtp_example.cfg
KataGo v1.16.3
Using TrompTaylor rules initially, unless GTP/GUI overrides this
Initializing board with boardXSize 19 boardYSize 19
Loaded config gtp_example.cfg
Loaded model g170e-b20c256x2-s5303129600-d1228401921.bin.gz
Model name: g170-b20c256x2-s5303129600-d1228401921
GTP ready, beginning main protocol loop
protocol_version
= 2

boardsize 9
Initializing board with boardXSize 9 boardYSize 9
=

komi 6.5
=

play b D4
=

genmove w
= D6
```

おー、動いた！でもgenmoveは1分以上掛かってるな。

maxVisitsを10にすると5秒くらいに。こんなもんでいいかも。

とりあえずここまでを公開。

[karino2/KataGo at android_fork](https://github.com/karino2/KataGo/tree/android_fork)

### gobandroidのGnuGoプラグインのコードを読む

サービスにしているのは知っているが、exeを呼んでるのかsoをJNIで呼んでるのかとかを調べていきたい。

以下か。

[ligi/gobandroid-ai-gnugo: this is a ai service for gnugo](https://github.com/ligi/gobandroid-ai-gnugo)

Android.mkは自分で書いていて、soになっている。

`src/main/jni/project/gnugo-3.8/interface/java_bridge.c` にJNIの実装があって、以下の２つだけを実装している。

```
void
Java_org_ligi_gobandroidhd_ai_gnugo_GnuGoConnection_initGTP (
	JNIEnv*	env,
	jclass clasz,
	jfloat memory
	)
{
	init_gtp (memory);
}

jstring
Java_org_ligi_gobandroidhd_ai_gnugo_GnuGoConnection_playGTP (
	JNIEnv*	env,
	jclass clasz,
	jstring input
	)
{
	char *cinput = (char*)(*env)->GetStringUTFChars (env, input, NULL);
	strcpy (gtp_input_line, cinput);
	gtp_output_line[0] = '\0';
	play_gtp ();
	(*env)->ReleaseStringUTFChars (env, input, cinput);
	return (*env)->NewStringUTF (env, gtp_output_line);
}
```

これくらいならすぐ作れそうだな。

### メモ

```
./katago gtp -config gtp_human20k.cfg -model your_favorite_normal_model_for_katago.bin.gz -human-model b18c384nbt-humanv0.bin.gz

./katago gtp -config gtp_human20k.cfg -model b18c384nbt-humanv0.bin.gz -human-model b18c384nbt-humanv0.bin.gz
```

weak2 s10014464弱すぎ、weak3 s14649344 強すぎ

### 弱い囲碁エンジンを求めて

[gnugo.git - gnugo](https://cgit.git.savannah.gnu.org/cgit/gnugo.git)

gnugoをlevel 0で触っているが、序盤が弱くて終盤が強すぎる。
ただgnugoは終盤が人間っぽいというかちゃんとパスしてくれる。

michiをN_SIMSを減らして見たが100だと動かなくて400だと強すぎる。

調べていたらこんなサブレを見つけた。

[What’s the best way to bring an AI down to my rank? : r/baduk](https://www.reddit.com/r/baduk/comments/fq0i33/whats_the_best_way_to_bring_an_ai_down_to_my_rank/)

zen7が弱いらしい。

何それ？とググっていたら以下のレーティングを見つける。

[breakwa11/GoAIRatings: Estimate Go AI ratings by real games](https://github.com/breakwa11/GoAIRatings/tree/master)

Amigoってのも弱いな、と調べて以下にいきつく。

[AmiGoGtp download - SourceForge.net](https://sourceforge.net/projects/amigogtp/)

ちょっと手を入れたらビルドが通った。少し戦うと弱さは自分と同じくらいで悪くない。
ただすごく弱い時とすごく強い時がある感じで、取り合いが強すぎて序盤が弱すぎる感じか。
まぁこれは割と戦える。

zen7は売り物っぽい。

go169というのもあったので調べてみるが、ソースは見つからない。けれど、その前身のGo81はソースがあった。

[Go81 for Palm by Tapani Raiko](https://users.ics.aalto.fi/praiko/go81/)

展開してみるとpalm用という感じだが少しいじればビルドは出来そう。Go169はAmiGoより強そうだがいい勝負っぽい。
Go81がいい感じに弱い可能性もあるが、強さが分からない段階でビルドしてみるのもなぁ。

とりあえず

- 初心者用はAmiGo
- スコアとかの基本的なライブラリとしてはGnuGo
- 分析はkatago b6の最強モデル

の３つがあればどうにかなるかな？

gnugoの2.6はconfigureしたら途中でこける。まぁそれはそうか。

少しいじってビルドを通した。gtpが無い。

デフォルトではちょっと勝てないくらい強いが `-D 4` を指定したら勝てた。


### 今後のToDo

エンジンまわり

- [x] gtpエンジン同士で何回か戦わせる仕組み整備
- [x] ２つのエンジンを同じくらいにしたり勝率2割くらいにしたりするパラメータの組み合わせを探す
- [x] 使う予定のエンジンをレポジトリをforkして公開
- [ ] AndroidのJNIの口を生やしてビルドを整備

アプリ周り

- [ ] アプリにエンジン組み込み
- [ ] forkしてレポジトリ公開
- [ ] Analyzeの組み込み
- [ ] AnalyzeのUI書き
- [ ] UI整備

### GTPエンジン同士を戦わせる

GnuGoにtwogtpというperlスクリプトがある。

試してみると、最後にfinal_scoreというコマンドを使うが、これにamigo_gtpが対応してなさそう。
自分が書いたgnugo 2.6の方には対応しておくか。

なんかBlackにすると最初にパスすることがあるな。再現条件が分からないが。＞clear_boardではfuseki_endedなどのフラグがクリアされてなかったりアゲハマがクリアされてない＞修正した。

```
./twogtp --white '../../../gnugo/interface/gnugo --mode gtp --level 0 --cosmic-gnugo' --black '../../../gnugo-2.6/interface/gnugo --mode gtp --quiet -D 4' --komi 6.5 --size 9 --games 10 --sgffile gnugo23
./twogtp --white '../../../amigogtp-1.8/amigogtp/amigogtp' --black '../../../gnugo-2.6/interface/gnugo --mode gtp --quiet -D 3' --komi 6.5 --size 9 --games 10 --sgffile gnugo2d3_amigo


./twogtp --white '../../../gnugo/interface/gnugo --mode gtp --level 0 --cosmic-gnugo' --black '../../../gnugo/interface/gnugo --mode gtp --level 5 --cosmic-gnugo' --komi 6.5 --size 9 --games 10 --sgffile gnugo33lv5
./twogtp --white '../../../amigogtp-1.8/amigogtp/amigogtp' --black '../../../gnugo-2.6/interface/gnugo --mode gtp --quiet -D 3' --komi 6.5 --size 9 --games 10 --sgffile gnugo2d3_amigo
./twogtp --white '../../../amigogtp-1.8/amigogtp/amigogtp amigo_lv1.cfg' --black '../../../amigogtp-1.8/amigogtp/amigogtp' --komi 6.5 --size 9 --games 10 --sgffile amigolv1_amigolv7_

ls amigolv1_amigolv7_*.sgf | xargs -I {}  ../gnugo --score finish {} | grep "wins by" > res_amigolv1_amigolv7.txt
```

gnugo2のD 0でno_fusekiだとたまにamigogtpに負けるな。40回やって2回くらい。

お、fusekiありにしたら40回やって4勝だ。布石がある方が負けるのか。

なんかgnugo2同士だとseedがちょっとずつしか変わらないせいか全く同じ棋譜が続いちゃうな。

- amigo lv1 vs amigo lv7: 2勝8敗
- gnugo2 D0 vs amigogtp lv7: 36勝4敗
- gnugo2 D 1 vs D 0: 23勝17敗
- gnugo2 D 4 vs D 0: 40勝0敗

gnugo2は4と0は結構違うな。gnugo 3はレベル変えてもあんま変わらんのだよな。

amigoのレベルはいい感じだな。このくらいに調整して欲しいものだが。