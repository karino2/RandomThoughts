import { resolveLanguage } from '../utils/index.js';
/**
 * Markdown-it plugin for pre wrapper
 *
 * 用于 pre 包装器的 markdown-it 插件
 *
 * @param md - Markdown instance / Markdown 实例
 * @param options - Plugin options / 插件选项
 * @example
 * ```ts
 * import { preWrapperPlugin } from '@vuepress/plugin-prismjs'
 * import MarkdownIt from 'markdown-it'
 *
 * const md = new MarkdownIt()
 * md.use(preWrapperPlugin, { preWrapper: true })
 * ```
 */
export const preWrapperPlugin = (md, { preWrapper = true } = {}) => {
    const rawFence = md.renderer.rules.fence;
    md.renderer.rules.fence = (...args) => {
        let result = rawFence(...args);
        const [tokens, idx, { langPrefix }] = args;
        const token = tokens[idx];
        // get token info
        const info = token.info ? md.utils.unescapeAll(token.info).trim() : '';
        // resolve language from token info
        const language = resolveLanguage(info);
        const languageClass = `${langPrefix}${language.name}`;
        result = result.replace(/<code[^]*?>/, `<code class="${languageClass}">`);
        if (!preWrapper || !result.startsWith('<pre')) {
            return result;
        }
        /**
         * Add information to dataset for current code block.
         */
        return `<div class="${languageClass}" data-highlighter="prismjs" data-ext="${language.ext}">${result.replace(` class="${languageClass}"`, '')}</div>`;
    };
};
