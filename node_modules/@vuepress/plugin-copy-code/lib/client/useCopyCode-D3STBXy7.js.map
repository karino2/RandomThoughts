{"version":3,"file":"useCopyCode-D3STBXy7.js","sources":["../../src/client/composables/useCopyCode.ts"],"sourcesContent":["import { Message, useLocale } from '@vuepress/helper/client'\nimport {\n  useClipboard,\n  useEventListener,\n  useMediaQuery,\n  watchImmediate,\n} from '@vueuse/core'\nimport { computed, nextTick } from 'vue'\nimport { onContentUpdated } from 'vuepress/client'\nimport type { CopyCodePluginLocaleConfig } from '../types.js'\n\nimport '@vuepress/helper/message.css'\nimport '../styles/copy-code.css'\nimport '../styles/vars.css'\n\n/**\n * Options for the useCopyCode composable\n *\n * useCopyCode 组合式 API 的选项\n */\nexport interface UseCopyCodeOptions {\n  /**\n   * Locale config for copy button\n   *\n   * 复制按钮的多语言配置\n   */\n  locales: CopyCodePluginLocaleConfig\n\n  /**\n   * Code block selector\n   *\n   * 代码块选择器\n   */\n  selector: string\n\n  /**\n   * Elements selector in code blocks to ignore when copying\n   *\n   * 复制时忽略的代码块中的元素选择器\n   */\n  ignoreSelector?: string\n\n  /**\n   * Inline code selector\n   *\n   * 行内代码选择器\n   */\n  inlineSelector?: string\n\n  /**\n   * Prompt message display time\n   *\n   * 提示消息显示时间\n   *\n   * @default 2000\n   */\n  duration: number\n\n  /**\n   * Whether to display on the mobile devices\n   *\n   * 是否在移动设备上显示\n   *\n   * @default false\n   */\n  showInMobile?: boolean\n  /**\n   * Transform pre element before copy\n   *\n   * 转换复制前的 pre 元素\n   *\n   * @description\n   * For example, deleting certain elements before copying, or inserting copyright information.\n   *\n   * 例如，在复制前删除特定元素，或插入版权信息。\n   *\n   * @param preElement `<pre>` clone Node\n   *\n   * @example\n   * ```ts\n   * {\n   *   transform(pre) {\n   *     // Remove all `.ignore` elements\n   *     pre.querySelectorAll('.ignore').forEach((el) => el.remove())\n   *     // insert copyright\n   *     pre.innerHTML += `\\n Copied by VuePress`\n   *   }\n   * }\n   * ```\n   */\n  transform?: (preElement: HTMLElement) => void\n}\n\nconst CHECK_ICON =\n  '<svg viewBox=\"0 0 1024 1024\" xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"#06a35a\"><path d=\"M822.812 824.618c-83.076 81.992-188.546 124.614-316.05 127.865-122.085-3.251-223.943-45.873-305.935-127.865S76.213 640.406 72.962 518.682c3.251-127.503 45.873-232.973 127.865-316.05 81.992-83.075 184.211-126.058 305.936-129.309 127.503 3.251 232.973 46.234 316.049 129.31 83.076 83.076 126.059 188.546 129.31 316.05-2.89 121.723-46.234 223.943-129.31 305.935zM432.717 684.111c3.973 3.974 8.307 5.78 13.364 6.14 5.057.362 9.753-1.444 13.365-5.417l292.57-287.515c3.974-3.973 5.78-8.307 5.78-13.364s-1.806-9.753-5.78-13.365l1.807 1.806c-3.973-3.973-8.669-5.779-14.087-6.14-5.418-.361-10.475 1.445-14.809 5.418L460.529 592.006c-3.973 3.25-8.669 4.695-14.448 4.695-5.78 0-10.836-1.445-15.531-3.973l-94.273-72.962c-4.335-3.251-9.392-4.335-14.448-3.973s-9.392 3.25-12.642 7.585l-2.89 3.973c-3.25 4.334-4.334 9.391-3.973 14.81.722 5.417 2.528 10.113 5.779 14.086L432.717 684.11z\"/></svg>'\nconst SHELL_RE = /language-(shellscript|shell|bash|sh|zsh)/\n\n/**\n * Use copy code function\n *\n * 使用复制代码功能\n *\n * @example\n * ```ts\n * // .vuepress/client.ts\n * import { useCopyCode } from '@vuepress/plugin-copy-code/client'\n *\n * export default {\n *   setup() {\n *     useCopyCode({\n *       selector: '.custom-code',\n *       duration: 3000,\n *       showInMobile: true\n *     })\n *   }\n * }\n * ```\n */\nexport const useCopyCode = ({\n  selector,\n  ignoreSelector,\n  inlineSelector,\n  duration = 2000,\n  locales,\n  showInMobile,\n  transform,\n}: UseCopyCodeOptions): void => {\n  if (__VUEPRESS_SSR__) return\n\n  /**\n   * On small-screen devices, the copy button is not displayed by default in order to prevent\n   * it from obstructing content, as the `:hover` effect can be triggered by `touch` events.\n   */\n  const isMobile = useMediaQuery('(max-width: 419px)')\n  const enabled = computed(() => !isMobile.value || showInMobile)\n\n  const locale = useLocale(locales)\n\n  const insertCopyButton = (codeBlockElement: HTMLElement): void => {\n    if (codeBlockElement.hasAttribute('copy-code')) return\n\n    const copyElement = document.createElement('button')\n\n    copyElement.type = 'button'\n    copyElement.classList.add('vp-copy-code-button')\n    copyElement.setAttribute('aria-label', locale.value.copy)\n    copyElement.setAttribute('data-copied', locale.value.copied)\n\n    codeBlockElement.parentElement?.insertBefore(copyElement, codeBlockElement)\n    codeBlockElement.setAttribute('copy-code', '')\n  }\n\n  const appendCopyButton = (): void => {\n    document.body.classList.toggle('no-copy-code', !enabled.value)\n    if (!enabled.value) return\n\n    document.querySelectorAll<HTMLElement>(selector).forEach(insertCopyButton)\n  }\n\n  watchImmediate(enabled, () => nextTick(appendCopyButton), {\n    flush: 'post',\n  })\n\n  onContentUpdated((reason) => {\n    if (reason !== 'beforeUnmount') appendCopyButton()\n  })\n\n  const { copy } = useClipboard({ legacy: true })\n  const timeoutIdMap = new WeakMap<HTMLElement, ReturnType<typeof setTimeout>>()\n  let message: Message | null = null\n\n  const copyContent = async (\n    codeContainer: HTMLDivElement,\n    codeContent: HTMLPreElement,\n    button: HTMLButtonElement,\n  ): Promise<void> => {\n    const clone = codeContent.cloneNode(true) as HTMLPreElement\n\n    if (ignoreSelector) {\n      clone.querySelectorAll(ignoreSelector).forEach((node) => {\n        node.remove()\n      })\n    }\n\n    if (transform) transform(clone)\n\n    let text = clone.textContent || ''\n\n    if (SHELL_RE.test(codeContainer.className))\n      text = text.replace(/^ *(\\$|>) /gm, '')\n\n    await copy(text)\n\n    if (duration <= 0) return\n\n    button.classList.add('copied')\n    clearTimeout(timeoutIdMap.get(button))\n    const timeoutId = setTimeout(() => {\n      button.classList.remove('copied')\n      button.blur()\n      timeoutIdMap.delete(button)\n    }, duration)\n    timeoutIdMap.set(button, timeoutId)\n  }\n\n  useEventListener(\n    'click',\n    (event) => {\n      const el = event.target as HTMLElement\n\n      if (\n        enabled.value &&\n        el.matches('div[class*=\"language-\"] > button.vp-copy-code-button')\n      ) {\n        const codeContainer = el.parentElement as HTMLDivElement | null\n        const preBlock = el.nextElementSibling as HTMLPreElement | null\n\n        if (!codeContainer || !preBlock) return\n\n        void copyContent(codeContainer, preBlock, el as HTMLButtonElement)\n      }\n    },\n    { passive: true },\n  )\n\n  if (inlineSelector) {\n    useEventListener(\n      'dblclick',\n      (event) => {\n        const el = event.target as HTMLElement\n\n        if (enabled.value && el.matches(inlineSelector)) {\n          const selection = window.getSelection()\n\n          if (\n            selection &&\n            (el.contains(selection.anchorNode) ||\n              el.contains(selection.focusNode))\n          ) {\n            selection.removeAllRanges()\n          }\n\n          void copy(el.textContent || '')\n          ;(message ??= new Message()).pop(\n            `${CHECK_ICON}<span>${locale.value.copied} </span>`,\n            duration,\n          )\n        }\n      },\n      { passive: true },\n    )\n  }\n}\n"],"names":["CHECK_ICON","SHELL_RE","useCopyCode","selector","ignoreSelector","inlineSelector","duration","locales","showInMobile","transform","isMobile","useMediaQuery","enabled","computed","locale","useLocale","insertCopyButton","codeBlockElement","copyElement","appendCopyButton","watchImmediate","nextTick","onContentUpdated","reason","copy","useClipboard","timeoutIdMap","message","copyContent","codeContainer","codeContent","button","clone","node","text","timeoutId","useEventListener","event","el","preBlock","selection","Message"],"mappings":"wWA6FA,MAAMA,EACJ,i+BACIC,EAAW,2CAuBJC,EAAc,CAAC,CAC1B,SAAAC,EACA,eAAAC,EACA,eAAAC,EACA,SAAAC,EAAW,IACX,QAAAC,EACA,aAAAC,EACA,UAAAC,CACF,IAAgC,CAC9B,GAAI,iBAAkB,OAMtB,MAAMC,EAAWC,EAAc,oBAAoB,EAC7CC,EAAUC,EAAS,IAAM,CAACH,EAAS,OAASF,CAAY,EAExDM,EAASC,EAAUR,CAAO,EAE1BS,EAAoBC,GAAwC,CAChE,GAAIA,EAAiB,aAAa,WAAW,EAAG,OAEhD,MAAMC,EAAc,SAAS,cAAc,QAAQ,EAEnDA,EAAY,KAAO,SACnBA,EAAY,UAAU,IAAI,qBAAqB,EAC/CA,EAAY,aAAa,aAAcJ,EAAO,MAAM,IAAI,EACxDI,EAAY,aAAa,cAAeJ,EAAO,MAAM,MAAM,EAE3DG,EAAiB,eAAe,aAAaC,EAAaD,CAAgB,EAC1EA,EAAiB,aAAa,YAAa,EAAE,CAC/C,EAEME,EAAmB,IAAY,CACnC,SAAS,KAAK,UAAU,OAAO,eAAgB,CAACP,EAAQ,KAAK,EACxDA,EAAQ,OAEb,SAAS,iBAA8BT,CAAQ,EAAE,QAAQa,CAAgB,CAC3E,EAEAI,EAAeR,EAAS,IAAMS,EAASF,CAAgB,EAAG,CACxD,MAAO,MACT,CAAC,EAEDG,EAAkBC,GAAW,CACvBA,IAAW,iBAAiBJ,GAClC,CAAC,EAED,KAAM,CAAE,KAAAK,CAAK,EAAIC,EAAa,CAAE,OAAQ,EAAK,CAAC,EACxCC,EAAe,IAAI,QACzB,IAAIC,EAA0B,KAE9B,MAAMC,EAAc,MAClBC,EACAC,EACAC,IACkB,CAClB,MAAMC,EAAQF,EAAY,UAAU,EAAI,EAEpC1B,GACF4B,EAAM,iBAAiB5B,CAAc,EAAE,QAAS6B,GAAS,CACvDA,EAAK,OAAA,CACP,CAAC,EAGCxB,GAAWA,EAAUuB,CAAK,EAE9B,IAAIE,EAAOF,EAAM,aAAe,GAOhC,GALI/B,EAAS,KAAK4B,EAAc,SAAS,IACvCK,EAAOA,EAAK,QAAQ,eAAgB,EAAE,GAExC,MAAMV,EAAKU,CAAI,EAEX5B,GAAY,EAAG,OAEnByB,EAAO,UAAU,IAAI,QAAQ,EAC7B,aAAaL,EAAa,IAAIK,CAAM,CAAC,EACrC,MAAMI,EAAY,WAAW,IAAM,CACjCJ,EAAO,UAAU,OAAO,QAAQ,EAChCA,EAAO,KAAA,EACPL,EAAa,OAAOK,CAAM,CAC5B,EAAGzB,CAAQ,EACXoB,EAAa,IAAIK,EAAQI,CAAS,CACpC,EAEAC,EACE,QACCC,GAAU,CACT,MAAMC,EAAKD,EAAM,OAEjB,GACEzB,EAAQ,OACR0B,EAAG,QAAQ,sDAAsD,EACjE,CACA,MAAMT,EAAgBS,EAAG,cACnBC,EAAWD,EAAG,mBAEpB,GAAI,CAACT,GAAiB,CAACU,EAAU,OAE5BX,EAAYC,EAAeU,EAAUD,CAAuB,CACnE,CACF,EACA,CAAE,QAAS,EAAK,CAClB,EAEIjC,GACF+B,EACE,WACCC,GAAU,CACT,MAAMC,EAAKD,EAAM,OAEjB,GAAIzB,EAAQ,OAAS0B,EAAG,QAAQjC,CAAc,EAAG,CAC/C,MAAMmC,EAAY,OAAO,eAGvBA,IACCF,EAAG,SAASE,EAAU,UAAU,GAC/BF,EAAG,SAASE,EAAU,SAAS,IAEjCA,EAAU,gBAAA,EAGPhB,EAAKc,EAAG,aAAe,EAAE,GAC5BX,IAAY,IAAIc,GAAW,IAC3B,GAAGzC,CAAU,SAASc,EAAO,MAAM,MAAM,WACzCR,CACF,CACF,CACF,EACA,CAAE,QAAS,EAAK,CAClB,CAEJ"}