'use strict';

const path = require('path');
const generate = require('markdown-it-testgen');
const sinon = require('sinon');
const assert = require('assert');
const MarkdownItWikilinks = require('../')

/*eslint-env mocha*/

describe('markdown-it-wikilinks', function () {
  it('should run the test suite correctly', () => {
    const plugin = MarkdownItWikilinks()
    const md = require('markdown-it')()
           .use(plugin);
    generate(
      path.join(
        __dirname,
        'fixtures/wikilinks.txt'
      ),
      md
    );
  });

  describe('postProcessPagePath', () => {
    const TEST_PAGE_NAME = 'contact';
    const TEST_MARKDOWN = '[[contact]]';
    const EXPECTED_OUTPUT = '<a href="./contact.html">contact</a>';

    function execute(postProcessCallbackName) {
      const cb = sinon.stub();
      cb.returns(TEST_PAGE_NAME);
      const opts = {};
      opts[postProcessCallbackName] = cb;
      const plugin = MarkdownItWikilinks(opts)
      const md = require('markdown-it')()
             .use(plugin);
      const result = md.renderInline(TEST_MARKDOWN);
      assert.equal(result, EXPECTED_OUTPUT);
      assert.equal(cb.calledOnce, true);
      assert.equal(cb.lastCall.args[0], TEST_PAGE_NAME);
    }

    it('should pass the correct arguments to postProcessPagePath', () => {
      execute('postProcessPagePath');
    });
  
    it('should retain backwards compatibility with postProcessPageName', () => {
      execute('postProcessPageName');
    });
  });

  describe('link must be normalize to NFC', () => {
    const TEST_PAGE_NAME = 'contact';
    /*
      This data is from MDN normalize.
      [String.prototype.normalize() - JavaScript - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/normalize)

      // normalized
      const name1 = "\u0041\u006d\u00e9\u006c\u0069\u0065";
      // non-normalized
      const name2 = "\u0041\u006d\u0065\u0301\u006c\u0069\u0065";

      input non-normalized unicode string should normalized for URL.
      For label, it's unclear whether it's better normalized or keep original, so I just keep original as is.
    */
    const TEST_MARKDOWN = '[[\u0041\u006d\u0065\u0301\u006c\u0069\u0065]]';
    const EXPECTED_OUTPUT = '<a href="./\u0041\u006d\u00e9\u006c\u0069\u0065.html">\u0041\u006d\u0065\u0301\u006c\u0069\u0065</a>';

    const plugin = MarkdownItWikilinks({})
    const md = require('markdown-it')()
            .use(plugin);
    const result = md.renderInline(TEST_MARKDOWN);
    console.log(result);

    assert.equal(result, EXPECTED_OUTPUT);
  });

  afterEach(() => {
    sinon.restore();
  });
});
